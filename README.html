<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head><title>Push SVN commit messages to JIRA</title></head>
<body>
<h1>Push SVN commit messages to JIRA</h1>
Version: 0.1.1

<h3>What is it?</h3>

<p>
This modification to the <a href="http://confluence.atlassian.com/display/JIRAEXT/JIRA+Subversion+plugin">Atlassian JIRA Subversion Plugin</a> adds the ability to
push SVN commit messages from a private/internal SVN repository to a public
JIRA server. It consists of
</p>
<ul>
<li>a simple <a href="http://svnkit.com/">SVNKit</a> protocol implementation, which I call svnkit-logdir (because it reads SVN commit log messages from a directory)</li>
<li>a small patch to the original JIRA Subversion Plugin (which adds the activation of the
new protocol implementation)</li>
<li>a set of shell scripts which transfer the commit messages from the private SVN server to the public JIRA server via SCP (or whatever you prefer instead)</li>
</ul>

<p>
<sub>(Whenever I mention <i>the plugin</i> in this document, I always mean the original Atlassian JIRA Subversion Plugin.)</sub>
</p>

<h3>Build Instruction</h3>

<p>
In order to use svnkit-logdir you have to patch and recompile the plugin.
</p>

<ol>
<li>
Get <a href="svnkit-logdir-0.1.1.jar">svnkit-logdir-0.1.1.jar</a> and install it into your local Maven repository:
<pre>mvn install:install-file -DgroupId=de.businessacts -DartifactId=svnkit-logdir -Dversion=0.1.1 -Dpackaging=jar -Dfile=/path/to/svnkit-logdir-0.1.1.jar
</pre>
Of course you can also compile svnkit-logdir from source (<a href="svnkit-logdir-0.1.1-src.zip">zip</a>, <a href="svnkit-logdir-0.1.1-src.tgz">tgz</a> or <a href="git://github.com/smu01/svnkit-logdir.git">git</a>).
</li> 
<li>Get plugin source code (see <a href="http://confluence.atlassian.com/display/JIRAEXT/JIRA+Subversion+plugin">Atlassian JIRA Subversion Plugin page</a>)</li>
<li>Patch plugin source code with <a href="foo.patch">foo.patch</a>, using your favorite patch utility (e.g. <a href="http://tortoisesvn.tigris.org/">TortoiseSVN</a> on Windows)</li>
<li>
Compile and package the plugin: <pre>mvn package</pre>
</li> 
</ol>
 
<h3>Install Instructions</h3>

<ol>
<li>Additionally to the plugin's original install instructions, copy <a href="svnkit-logdir-0.1.1.jar">svnkit-logdir-0.1.1.jar</a> to JIRA's WEB-INF/lib directory.</li>
<li>In the same directory, replace the original plugin JAR with the patched one from above.</li>
<li>Add a new repository to JIRA with the repository root set to <em>logdir:///path/to/svnlogs</em></li>
<li>
Configure your Subversion server to copy the commit messages to your JIRA server, e.g. from inside a post-commit hook script.
In my experience it is a good idea to separate the generating of the XML log files from the actual transmission to the remote
JIRA server, because the Subversion commit gets blocked until the post-commit script is completed. Therefore it may
be wise to do the time consuming work outside of the post-commit script.
I came up with the following set of scripts:
<ol>
<li>A Subversion <i>post-commit</i> script, normally located inside the <i>hooks</i> directory of your Subversion repository.
<pre>
#!/bin/sh
/path/to/scripts/svnlogxml $1 $2
</pre>
</li>
<li>A Bash script named <i>svnlogxml</i>, which is called by the above post-commit script and dumps the commit message into a XML file inside a queue directory.
<pre>
#!/bin/sh
REPOS="$1"
REV="$2"
PATH="/path/to/queue"
FILE="commit.r$REV.xml"
/usr/bin/svn log --xml -v -r $REV file://$REPOS > $PATH/$FILE
</pre>
</li>
<li>A bash script named <i>svnlog-queuerunner</i>, which is called from cron and transfers all new XML files to the JIRA server via SCP
(you'll need private/public keys in order to log in from the scripts without a password prompt!).
<pre>
#!/bin/sh
PATH="/path/to/queue"
for f in `/usr/bin/find $PATH -name commit.r*.xml -printf "%f\n"`;
do
  /usr/bin/scp $PATH/$f username@jiraserver:./remote/path/to/logs/$f &amp;&amp; /bin/rm $PATH/$f
done
</pre>
</li>
<li>A Bash script named <i>svnlogxml-all</i>, which dumps all existing commit messages to the queue directory (via the above svnlogxml script),
so that JIRA also receives all old commit messages (i.e. messages from commits created before the post-commit script was installed).
<pre id="svnlogxml-all">
#!/bin/sh
REPOS="$1"
REV=`/usr/bin/svnlook youngest $REPOS`
counter=0
until [ $counter -eq $REV ]
do
    counter=$(( $counter + 1 ))
    /path/to/scripts/svnlogxml $REPOS $counter
done
</pre>
</li>
</ol>
</li>
</ol>

<h3>More</h3>

<ul>
<li>GIT repository: <a href="http://github.com/smu01/svnkit-logdir/">http://github.com/smu01/svnkit-logdir/</a></li>
<li>Atlassian JIRA Subversion Plugin page: <a href="http://confluence.atlassian.com/display/JIRAEXT/JIRA+Subversion+plugin">http://confluence.atlassian.com/display/JIRAEXT/JIRA+Subversion+plugin</a></li>
</ul>
</body>
</html>